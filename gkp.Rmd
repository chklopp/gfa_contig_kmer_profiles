---
title: "Kmer profile"
output: 
  html_document:
    toc: true
    toc_depth: 2

date: "2025-10-22"
params:
  lc:
    value: x
  kmerp:
    value: x
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(plyr)
library(stringr)
library(pheatmap)
library(reshape2)
```

## Loading data files

This Rmarkdown script takes two parameters : lc which is the length coverage file produced using the gfa file from hifiasm which contains 3 columns : contig name, length, coverage separated by tabulations and the kmer profile file which contains for each contig the normalized kmer profile generated by ~/save/Python/contig_kmer_profile.py

```{r load}
print(params$lc)
print(params$kmerp)
length_coverage <- read.table(params$lc, h=F, row.names=1)
kmer_profile <- read.table(params$kmerp, h=F, row.names=1)
print(dim(length_coverage))
print(dim(kmer_profile))
names(length_coverage) <- c("length","cov")
names(kmer_profile) <- c("length","c1","c2","c3","c4-10","c11-20","c21-100","c101-1000","c1001-10000","c10001-100000","c100001+")
```

## Tables

head of both tables 

```{r tables}
head(length_coverage)
head(kmer_profile)
```

## log10 length versus coverage

head of both tables 

```{r log10_length_coverage}
ggplot(length_coverage, aes(x=log10(length), y=cov)) + geom_point() + geom_density2d()
```

## log10 length versus coverage removing very covered contigs 

head of both tables 

```{r log10_length_coverage_filtered}
med = median(length_coverage$cov)
low_cov_names <- row.names(length_coverage[length_coverage$cov < med/1.5 & length_coverage$length < 500000, ])
print(med)
print(length(low_cov_names))
ggplot(length_coverage[length_coverage$cov < 3*med, ], aes(x=log10(length), y=cov)) + geom_point() + geom_density2d()

length_coverage$low <- 0
length_coverage[row.names(length_coverage) %in% low_cov_names, ]$low <- 1 
ggplot(length_coverage[length_coverage$cov < 3*med, ], aes(x=log10(length), y=cov, colour=low)) + geom_point() + geom_density2d()
```

## contig profile heatmap

head of both tables 

```{r heatmap}
kmer_profile2 <- kmer_profile[,2:11]

pheatmap(kmer_profile2, cluster_cols=F, show_rownames = FALSE)
```


## contig profile heatmap for contigs with low coverage

head of both tables 

```{r heatmap_low_cov}

pheatmap(kmer_profile2[row.names(kmer_profile2) %in% low_cov_names, ], cluster_cols=F, show_rownames = FALSE)
#pheatmap(kmer_profile2[!(row.names(kmer_profile2) %in% low_cov_names), ], cluster_cols=F)
```

## contig profile heatmap for contigs with high coverage

head of both tables 

```{r heatmap_high_cov}

#pheatmap(kmer_profile2[row.names(kmer_profile2) %in% low_cov_names, ], cluster_cols=F)
pheatmap(kmer_profile2[!(row.names(kmer_profile2) %in% low_cov_names), ], cluster_cols=F, show_rownames = FALSE)
```
 
## clustering 

head of both tables 

```{r cah}
library(amap)
d <- Dist(as.matrix(kmer_profile2), method = "pearson")
hc <- hclust(d) 

# intraclass inertia plot 
head(kmer_profile2)
#plot(hc$height[length(hc$height):length(hc$height)-50],type="b")
plot(hc$height,type="b")
#hc$height
#length(hc$height)-50
#length(hc$height)
#hc$height[length(hc$height):length(hc$height)-50]

# set automatic profile cutting 
l1 <- hc$height < 0.4

nbclass = length(hc$height) - which(hc$height > 0.5)[1]
#nbclass= 6 

classif<-cutree(hc,k=nbclass)
kmer_profile2.G <- as.data.frame(classif)
kmer_profile2_classif <- merge(kmer_profile2, kmer_profile2.G, by=0, all=TRUE)
head(kmer_profile2_classif)
table(kmer_profile2_classif$classif)

length_coverage_classif <- merge(length_coverage, kmer_profile2.G, by=0, all=TRUE)
head(length_coverage_classif)
ggplot(length_coverage_classif[length_coverage_classif$cov < 3*med, ], aes(x=log10(length), y=cov, colour=as.factor(classif))) + geom_point() # + geom_density2d()

kmer_profile2_classif_melt <- melt(kmer_profile2_classif[,1:11], id="Row.names")

for (i in 1:nbclass){
    cat('\n')  
    cat("-> Class ", i, " in 6\n")
    cat('\n')
    #print(i)
    #print(kmer_profile2_classif[kmer_profile2_classif$classif %in% c(as.character(i)),]$Row.names)
    #print(length_coverage_classif[length_coverage_classif$Row.names %in% kmer_profile2_classif[kmer_profile2_classif$classif %in% c(as.character(i)),]$Row.names,])
    ll = length_coverage_classif[length_coverage_classif$Row.names %in% kmer_profile2_classif[kmer_profile2_classif$classif %in% c(as.character(i)),]$Row.names,]
    #print(ll)
    str(ll)
    print(dim(ll))
    print(ggplot(ll, aes(x=log10(length), y=cov, colour=low)) + geom_point())
    class_table = kmer_profile2_classif_melt[kmer_profile2_classif_melt$Row.names %in% kmer_profile2_classif[kmer_profile2_classif$classif %in% c(as.character(i)),]$Row.names,]
    print(ggplot(class_table, aes(x=variable,
 y=value, group=Row.names)) + geom_line() + theme(axis.text.x = element_text(angle = 90, hjust = 1)))
    #print(head(class_table))
    print(ggplot(class_table, aes(x=value, 
 y=Row.names)) + geom_bar(stat="identity", aes(fill=variable), position = position_stack(reverse = TRUE)) + theme(axis.text.x = element_text(angle = 90, hjust = 1), axis.text.y=element_blank()))
}

```
